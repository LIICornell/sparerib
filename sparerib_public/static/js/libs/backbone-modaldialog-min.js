Backbone.ModalView=Backbone.View.extend({name:"ModalView",modalBlanket:null,modalContainer:null,defaultOptions:{fadeInDuration:150,fadeOutDuration:150,showCloseButton:!0,bodyOverflowHidden:!1,setFocusOnFirstFormControl:!0,targetContainer:document.body,slideFromAbove:!1,slideFromBelow:!1,slideDistance:150,closeImageUrl:"close-modal.png",closeImageHoverUrl:"close-modal-hover.png",showModalAtScrollPosition:!0,permanentlyVisible:!1,backgroundClickClosesModal:!0,pressingEscapeClosesModal:!0,css:{border:"2px solid #111",
"background-color":"#fff","-webkit-box-shadow":"0px 0px 15px 4px rgba(0, 0, 0, 0.5)","-moz-box-shadow":"0px 0px 15px 4px rgba(0, 0, 0, 0.5)","box-shadow":"0px 0px 15px 4px rgba(0, 0, 0, 0.5)","-webkit-border-radius":"10px","-moz-border-radius":"10px","border-radius":"10px"}},initialize:function(){},events:{},showModalBlanket:function(){return this.ensureModalBlanket().fadeIn(this.options.fadeInDuration)},hideModalBlanket:function(){return this.modalBlanket.fadeOut(this.options.fadeOutDuration)},ensureModalContainer:function(a){null!=
a&&null!=this.modalContainer&&(this.modalContainer.remove(),this.modalContainer=null);null==this.modalContainer&&(this.modalContainer=$("<div id='modalContainer'>").css({"z-index":"99999",position:"relative","-webkit-border-radius":"6px","-moz-border-radius":"6px","border-radius":"6px"}).appendTo(a));return this.modalContainer},ensureModalBlanket:function(){this.modalBlanket=$("#modal-blanket");0==this.modalBlanket.length?this.modalBlanket=$("<div id='modal-blanket'>").css({position:"absolute",top:0,
left:0,height:$(document).height(),width:"100%",opacity:0.5,backgroundColor:"#000","z-index":99900}).appendTo(document.body).hide():this.modalBlanket.css({height:$(document).height(),width:"100%"});return this.modalBlanket},keyup:function(a){27==a.keyCode&&this.options.pressingEscapeClosesModal&&this.hideModal()},click:function(a){"modal-blanket"==a.target.id&&this.options.backgroundClickClosesModal&&this.hideModal()},setFocusOnFirstFormControl:function(){var a=$("input, select, email, url, number, range, date, month, week, time, datetime, datetime-local, search, color",
$(this.el));0<a.length&&$(a[0]).focus()},hideModal:function(){this.trigger("closeModalWindow");this.hideModalBlanket();$(document.body).unbind("keyup",this.keyup);this.modalBlanket.unbind("click",this.click);!0===this.options.bodyOverflowHidden&&$(document.body).css("overflow",this.originalBodyOverflowValue);var a=this.modalContainer;$(this.modalContainer).fadeOut(this.options.fadeOutDuration,function(){a.remove()})},getCoordinate:function(a,b){if("undefined"!==typeof b[a]){var d=b[a];delete b[a];
return d}},recenter:function(){return this.recentre()},recentre:function(){var a=$(this.el);this.getCoordinate("top",this.options.css);this.getCoordinate("left",this.options.css);this.getCoordinate("right",this.options.css);this.getCoordinate("bottom",this.options.css);var b=this.getOffsets(),d=$(window).height()/2,g=$(window).width()/2,c=this.modalContainer,d=d-a.outerHeight()/2;c.css({top:d+b.y+"px"});a=g-a.outerWidth()/2;c.css({left:a+b.x+"px"});return this},getOffsets:function(){var a=0,b=0;this.options.showModalAtScrollPosition&&
(a=$(document).scrollTop(),b=$(document).scrollLeft());return{x:b,y:a}},showModal:function(a){this.defaultOptions.targetContainer=document.body;this.options=$.extend(!0,{},this.defaultOptions,a,this.options);this.options.permanentlyVisible&&(this.options.showCloseButton=!1,this.options.backgroundClickClosesModal=!1,this.options.pressingEscapeClosesModal=!1);var b=$(this.el),d=$(window).height()/2,g=$(window).width()/2;a=this.ensureModalContainer(this.options.targetContainer).empty();b.addClass("modal");
var c={top:this.getCoordinate("top",this.options.css),left:this.getCoordinate("left",this.options.css),right:this.getCoordinate("right",this.options.css),bottom:this.getCoordinate("bottom",this.options.css),isEmpty:function(){return null==this.top&&null==this.left&&null==this.right&&null==this.bottom}};b.css(this.options.css);this.showModalBlanket();this.keyup=_.bind(this.keyup,this);this.click=_.bind(this.click,this);$(document.body).keyup(this.keyup);this.modalBlanket.click(this.click);!0===this.options.bodyOverflowHidden&&
(this.originalBodyOverflowValue=$(document.body).css("overflow"),$(document.body).css("overflow","hidden"));a.append(b);a.css({opacity:0,position:"absolute","z-index":999999});var e=this.getOffsets();c.isEmpty()?(d-=b.outerHeight()/2,10>d&&(d=10),d="undefined"!==typeof this.options.y?this.options.y:d+e.y,a.css({top:d+"px"}),b=g-b.outerWidth()/2,b="undefined"!==typeof this.options.x?this.options.x:b+e.x,a.css({left:b+"px"})):(null!=c.top&&a.css({top:c.top+e.y}),null!=c.left&&a.css({left:c.left+e.x}),
null!=c.right&&a.css({right:c.right}),null!=c.bottom&&a.css({bottom:c.bottom}));this.options.setFocusOnFirstFormControl&&this.setFocusOnFirstFormControl();if(this.options.showCloseButton){var f=this;$("<a href='#' id='modalCloseButton'>&#160;</a>").css({position:"absolute",top:"-10px",right:"-10px",width:"32px",height:"32px",background:"transparent url("+f.options.closeImageUrl+") top left no-repeat","text-decoration":"none"}).appendTo(this.modalContainer).hover(function(){$(this).css("background-image",
"url("+f.options.closeImageHoverUrl+") !important")},function(){$(this).css("background-image","url("+f.options.closeImageUrl+") !important")}).click(function(a){a.preventDefault();f.hideModal()})}e={opacity:1};b=a.offset();this.options.slideFromAbove&&(a.css({top:b.top-this.options.slideDistance+"px"}),e.top=c.top);this.options.slideFromBelow&&(a.css({top:b.top+this.options.slideDistance+"px"}),e.top=c.top);this.modalContainer.animate(e,this.options.fadeInDuration);return this}});
